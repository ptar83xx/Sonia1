<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d1117" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Matematyka Piesk√≥w dla Sonii</title>

  <style>
    :root{
      --bg:#0d1117;
      --border:#30363d;
      --text:#c9d1d9;
      --muted:#8b949e;
      --blue:#58a6ff;
      --green:#2ea043;
      --red:#f85149;
      --yellow:#d29922;
      --purple:#a371f7;
      --shadow:rgba(0,0,0,.35);
      --r18:18px;
      --r16:16px;
      --vh: 1vh;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1100px 760px at 20% 0%, rgba(88,166,255,.10), transparent 55%),
        radial-gradient(900px 650px at 80% 20%, rgba(163,113,247,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overscroll-behavior:none;
      touch-action:manipulation;
      overflow-x:hidden;
    }

    /* ===== SELECT SCREEN ===== */
    .safe{
      padding:
        calc(16px + env(safe-area-inset-top))
        calc(16px + env(safe-area-inset-right))
        calc(16px + env(safe-area-inset-bottom))
        calc(16px + env(safe-area-inset-left));
      min-height:100%;
      display:grid;
      place-items:center;
    }
    .app{ width:min(980px, 100%); display:grid; gap:14px; }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(22,27,34,.85);
      border:1px solid var(--border);
      box-shadow: 0 10px 26px var(--shadow);
      font-size:14px;
      line-height:1;
      white-space:nowrap;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      padding:2px 7px;
      border-radius:8px;
      background: rgba(88,166,255,.12);
      border:1px solid rgba(88,166,255,.28);
      color: var(--text);
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--r18);
      background: linear-gradient(180deg, rgba(22,27,34,.96), rgba(22,27,34,.90));
      box-shadow: 0 18px 44px var(--shadow);
      overflow:hidden;
    }

    .title{
      display:grid;
      gap:6px;
      text-align:center;
      padding: 18px 18px 10px;
    }
    .title h1{
      margin:0;
      font-size: clamp(26px, 3.5vw, 40px);
      font-weight: 950;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    .select{
      padding: 10px 18px 18px;
      display:grid;
      gap:12px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    label.nick{
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    input[type="text"]{
      font-size:16px; /* iOS: bez zoomu */
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.70);
      color: var(--text);
      outline:none;
      min-width: 180px;
    }
    input[type="text"]:focus{
      border-color: rgba(88,166,255,.60);
      box-shadow: 0 0 0 2px rgba(88,166,255,.14);
    }

    /* 3 small tiles */
    .tileRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){
      .tileRow{ grid-template-columns: 1fr; }
    }
    .tile{
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(13,17,23,.40);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 72px;
      transition: transform 70ms ease, border-color 120ms ease, background 120ms ease;
    }
    .tile:active{ transform: translateY(1px); }
    .tile:hover{
      border-color: rgba(88,166,255,.40);
      background: rgba(13,17,23,.52);
    }
    .tile .left{ display:grid; gap:2px; }
    .tile strong{ font-size: 15px; font-weight: 950; letter-spacing:.2px; }
    .tile span{ font-size: 12px; color: var(--muted); }
    .chip{
      font-size: 12px;
      font-weight: 950;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(163,113,247,.45);
      background: rgba(163,113,247,.12);
      white-space:nowrap;
    }

    /* Ranking */
    .subCard{
      margin-top: 4px;
      border:1px solid rgba(48,54,61,.95);
      border-radius: var(--r16);
      background: rgba(13,17,23,.35);
      padding: 14px;
      display:grid;
      gap:10px;
    }
    .subHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tab{
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      padding: 9px 10px;
      border-radius: 999px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.55);
      color: var(--text);
      font-size: 12px;
      font-weight: 950;
    }
    .tab.active{
      border-color: rgba(163,113,247,.55);
      box-shadow: 0 0 0 2px rgba(163,113,247,.14);
      background: rgba(163,113,247,.10);
    }
    .tableWrap{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.45);
    }
    table{ width:100%; border-collapse: collapse; font-size: 13px; }
    th, td{ padding: 10px 10px; border-bottom:1px solid rgba(48,54,61,.75); text-align:left; }
    th{
      color: var(--muted);
      font-weight: 950;
      font-size: 12px;
      background: rgba(13,17,23,.35);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:last-child td{ border-bottom:none; }
    .rank{ width:56px; color:var(--muted); font-weight: 950; }
    .time{ font-variant-numeric: tabular-nums; font-weight: 950; }
    .tiny{ color: var(--muted); font-size: 12px; line-height:1.35; }

    /* ===== FULLSCREEN PLAY ===== */
    .fullscreen{
      position: fixed;
      inset: 0;
      z-index: 999;
      display: none;
      height: 100dvh;
      height: calc(var(--vh) * 100);
      background:
        radial-gradient(1100px 760px at 20% 0%, rgba(88,166,255,.10), transparent 55%),
        radial-gradient(900px 650px at 80% 20%, rgba(163,113,247,.10), transparent 55%),
        var(--bg);
    }
    .fullscreen.show{ display:block; }

    .playSafe{
      width:100%;
      height:100%;
      padding:
        calc(12px + env(safe-area-inset-top))
        calc(12px + env(safe-area-inset-right))
        calc(12px + env(safe-area-inset-bottom))
        calc(12px + env(safe-area-inset-left));
      display:grid;
    }

    .playCard{
      position:relative;
      width:100%;
      height:100%;
      border:1px solid var(--border);
      border-radius: var(--r18);
      background: linear-gradient(180deg, rgba(22,27,34,.96), rgba(22,27,34,.90));
      box-shadow: 0 18px 44px var(--shadow);
      overflow:hidden;
      display:grid;
    }

    .playPad{
      padding:16px;
      height:100%;
      display:grid;
      gap:12px;
      grid-template-rows: auto auto 1fr auto; /* + keypad row */
    }

    .playTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }

    .miniBtn{
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(13,17,23,.55);
      color: var(--text);
      font-weight: 950;
      font-size: 12px;
    }
    .miniBtn:active{ transform: translateY(1px); }

    .hud{
      display:grid;
      gap:10px;
    }
    .bars{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){
      .bars{ grid-template-columns: 1fr; }
    }
    .barlabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      margin: 0 2px 6px;
    }
    .progress{
      height:10px;
      border-radius:999px;
      background: rgba(139,148,158,.14);
      border:1px solid rgba(48,54,61,.85);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(88,166,255,.95), rgba(46,160,67,.95));
      transition: width 220ms ease;
    }
    .timer > div{
      background: linear-gradient(90deg, rgba(210,153,34,.95), rgba(248,81,73,.95));
      transition: width 80ms linear;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .stat{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(48,54,61,.9);
      background: rgba(13,17,23,.55);
      font-size:13px;
      color: var(--text);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .lives{
      display:inline-flex;
      gap:6px;
      vertical-align:middle;
      margin-left:6px;
    }
    .heart{
      width:12px;height:12px;border-radius:3px;
      background: rgba(248,81,73,.35);
      border:1px solid rgba(248,81,73,.55);
      box-shadow: 0 0 0 2px rgba(248,81,73,.07);
    }
    .heart.on{
      background: rgba(248,81,73,.9);
      border-color: rgba(248,81,73,.95);
      box-shadow: 0 0 0 2px rgba(248,81,73,.18);
    }

    .questionWrap{
      display:grid;
      gap:10px;
      padding:14px;
      border-radius: var(--r16);
      border:1px solid rgba(48,54,61,.95);
      background: linear-gradient(180deg, rgba(13,17,23,.55), rgba(13,17,23,.35));
      box-shadow: 0 0 0 1px rgba(88,166,255,.18), 0 0 34px rgba(88,166,255,.08);
      align-content:start;
    }
    .questionLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .big{
      font-size: clamp(30px, 5.4vw, 56px);
      font-weight: 950;
      letter-spacing:.4px;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(88,166,255,.12);
      border:1px solid rgba(88,166,255,.28);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
      color: var(--text);
    }

    .answers{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){
      .answers{ grid-template-columns: 1fr; }
    }
    .ansBtn{
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      padding: 18px 12px;
      border-radius: 18px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.70);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 950;
      font-size: 28px;
      letter-spacing:.3px;
      transition: transform 70ms ease, background 120ms ease, border-color 120ms ease;
    }
    .ansBtn:active{ transform: translateY(1px); }
    .ansBtn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .danger{
      border-color: rgba(248,81,73,.65) !important;
      box-shadow: 0 0 0 2px rgba(248,81,73,.12) !important;
    }
    .shake{ animation: shake 220ms ease-in-out 1; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* ===== Typing mode UI ===== */
    .typeWrap{
      display:none;
      gap:10px;
      padding: 12px;
      border-radius: var(--r16);
      border:1px solid rgba(48,54,61,.95);
      background: rgba(13,17,23,.35);
    }
    .typeWrap.show{ display:grid; }

    .typeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .typeDisplay{
      flex: 1;
      min-width: 220px;
      padding: 14px 14px;
      border-radius: 16px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.70);
      font-size: 28px;
      font-weight: 950;
      letter-spacing: .4px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .tries{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(210,153,34,.55);
      background: rgba(210,153,34,.10);
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      color: var(--text);
    }

    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .key{
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      padding: 16px 12px;
      border-radius: 16px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(22,27,34,.70);
      font-weight: 980;
      font-size: 22px;
      text-align:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.16);
    }
    .key:active{ transform: translateY(1px); }
    .key.ok{
      border-color: rgba(46,160,67,.55);
      background: rgba(46,160,67,.12);
    }
    .key.del{
      border-color: rgba(248,81,73,.55);
      background: rgba(248,81,73,.10);
    }
    .key:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* ===== Overlay ===== */
    .stage{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:grid;
      place-items:center;
    }
    .stageInner{
      width: min(760px, 94%);
      display:grid;
      place-items:center;
      gap:12px;
      padding: 8px;
    }
    .toast{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(48,54,61,.95);
      background: rgba(13,17,23,.80);
      color: var(--text);
      font-weight: 950;
      font-size: 14px;
      text-align:center;
      opacity:0;
      transform: translateY(8px);
      transition: opacity 140ms ease, transform 140ms ease;
      max-width: 680px;
    }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Win message (2x bigger) */
    .winMsg{
      display:none;
      text-align:center;
      padding: 18px 18px;
      border-radius: 18px;
      border:1px solid rgba(46,160,67,.55);
      background: rgba(46,160,67,.10);
      box-shadow: 0 0 0 2px rgba(46,160,67,.12), 0 18px 40px rgba(0,0,0,.28);
      max-width: 820px;
    }
    .winMsg.show{ display:block; }
    .winMsg .h{
      font-size: clamp(34px, 6.2vw, 68px); /* ~2x */
      font-weight: 990;
      letter-spacing:.2px;
      margin:0;
    }
    .winMsg .s{
      margin-top:10px;
      color: rgba(201,209,217,.88);
      font-size: 14px;
      line-height:1.35;
    }

    /* Happy dog */
    .dog{
      width:240px;height:170px;
      position:relative;
      display:none;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.25));
    }
    .dog.show{ display:block; }
    .dog .body{
      position:absolute; left:66px; top:70px;
      width:130px; height:76px; border-radius:44px;
      background: rgba(88,166,255,.16);
      border:2px solid rgba(88,166,255,.55);
    }
    .dog .head{
      position:absolute; left:28px; top:52px;
      width:78px; height:66px; border-radius:24px;
      background: rgba(46,160,67,.14);
      border:2px solid rgba(46,160,67,.55);
    }
    .dog .ear{
      position:absolute; width:24px;height:28px; border-radius:10px;
      background: rgba(46,160,67,.10);
      border:2px solid rgba(46,160,67,.45);
      top:36px; left:38px;
      transform: rotate(-12deg);
    }
    .dog .ear.e2{ left:64px; top:38px; transform: rotate(10deg); }
    .dog .eye{
      position:absolute; width:6px;height:6px;border-radius:999px;
      background: rgba(201,209,217,.92);
      border:1px solid rgba(48,54,61,.95);
      top:74px; left:56px;
    }
    .dog .eye.e2{ left:78px; }
    .dog .snout{
      position:absolute; width:40px;height:26px; border-radius:14px;
      background: rgba(201,209,217,.10);
      border:2px solid rgba(48,54,61,.75);
      top:92px; left:50px;
    }
    .dog .nose{
      position:absolute; width:10px;height:7px;border-radius:999px;
      background: rgba(248,81,73,.85);
      top:98px; left:66px;
      box-shadow: 0 0 0 2px rgba(248,81,73,.12);
    }
    .dog .leg{
      position:absolute; width:12px;height:28px; border-radius:8px;
      background: rgba(88,166,255,.12);
      border:2px solid rgba(88,166,255,.45);
      top:132px;
    }
    .dog .leg.l1{ left:96px; }
    .dog .leg.l2{ left:130px; }
    .dog .leg.l3{ left:164px; }
    .dog .tail{
      position:absolute; left:190px; top:86px;
      width:56px; height:12px; border-radius:999px;
      background: rgba(163,113,247,.16);
      border:2px solid rgba(163,113,247,.55);
      transform-origin: 6px 6px;
      transform: rotate(18deg);
    }
    .dog.wag .tail{ animation: wag 220ms ease-in-out infinite; }
    @keyframes wag{
      0%{ transform: rotate(16deg); }
      50%{ transform: rotate(-18deg); }
      100%{ transform: rotate(16deg); }
    }
    .dog .spark{
      position:absolute; left:124px; top:16px;
      width:10px;height:10px;border-radius:999px;
      background: rgba(210,153,34,.85);
      box-shadow: 18px 6px 0 rgba(88,166,255,.85),
                  -18px 10px 0 rgba(163,113,247,.85);
      opacity:0;
    }
    .dog.wag .spark{ animation: pop 240ms ease-out 1; opacity:1; }
    @keyframes pop{
      0%{ transform: scale(.6); opacity:0; }
      35%{ transform: scale(1.1); opacity:1; }
      100%{ transform: scale(1.3); opacity:0; }
    }

    /* Crying dog (scaled ~3x) */
    .sadDog{
      width:220px; height:180px;
      position:relative;
      display:none;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.28));
      transform: scale(3); /* ~3x */
      transform-origin: center;
    }
    .sadDog.show{ display:block; }
    .sadDog .head{
      position:absolute; left:50%; top:46px;
      width:140px; height:120px;
      transform: translateX(-50%);
      border-radius: 34px;
      background: rgba(46,160,67,.10);
      border:2px solid rgba(46,160,67,.55);
    }
    .sadDog .ear{
      position:absolute; top:22px;
      width:34px; height:46px;
      border-radius: 14px;
      background: rgba(46,160,67,.08);
      border:2px solid rgba(46,160,67,.45);
    }
    .sadDog .ear.e1{ left:44px; transform: rotate(-18deg); }
    .sadDog .ear.e2{ right:44px; transform: rotate(18deg); }
    .sadDog .eye{
      position:absolute; top:88px;
      width:10px; height:10px;
      border-radius:999px;
      background: rgba(201,209,217,.92);
      border:1px solid rgba(48,54,61,.95);
    }
    .sadDog .eye.e1{ left:74px; }
    .sadDog .eye.e2{ right:74px; }
    .sadDog .brow{
      position:absolute;
      width:28px; height:10px;
      border-top:2px solid rgba(201,209,217,.55);
      border-radius: 999px;
      top:78px;
    }
    .sadDog .brow.b1{ left:66px; transform: rotate(12deg); }
    .sadDog .brow.b2{ right:66px; transform: rotate(-12deg); }
    .sadDog .snout{
      position:absolute; left:50%; top:114px;
      width:70px; height:44px;
      transform: translateX(-50%);
      border-radius: 22px;
      background: rgba(201,209,217,.08);
      border:2px solid rgba(48,54,61,.75);
    }
    .sadDog .nose{
      position:absolute; left:50%; top:126px;
      width:16px; height:10px;
      transform: translateX(-50%);
      border-radius:999px;
      background: rgba(248,81,73,.85);
      box-shadow: 0 0 0 2px rgba(248,81,73,.12);
    }
    .sadDog .mouth{
      position:absolute; left:50%; top:144px;
      width:44px; height:22px;
      transform: translateX(-50%);
      border-bottom: 3px solid rgba(201,209,217,.60);
      border-radius: 0 0 999px 999px;
      opacity:.9;
    }
    .sadDog .tear{
      position:absolute; top:102px;
      width:10px; height:14px;
      border-radius: 999px;
      background: rgba(88,166,255,.55);
      border:1px solid rgba(88,166,255,.65);
      opacity:.85;
    }
    .sadDog .tear.t1{ left:84px; transform: rotate(8deg); }
    .sadDog .tear.t2{ right:84px; transform: rotate(-8deg); }

    /* Bigger Bone */
    .bone{
      width:260px;height:92px;
      position:relative;
      display:none;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.45));
    }
    .bone.show{ display:block; }
    .bone .mid{
      position:absolute; left:52px; top:32px;
      width:156px; height:28px; border-radius:999px;
      background: rgba(201,209,217,.10);
      border:2px solid rgba(201,209,217,.40);
    }
    .bone .cap{
      position:absolute; width:44px;height:44px;border-radius:16px;
      background: rgba(201,209,217,.08);
      border:2px solid rgba(201,209,217,.40);
      top:24px;
    }
    .bone .c1{ left:22px; transform: rotate(14deg); }
    .bone .c2{ left:196px; transform: rotate(-14deg); }
    .bone.drop{ animation: fall 420ms cubic-bezier(.18,.95,.18,1) 1; }
    @keyframes fall{
      0%{ transform: translateY(-260px) rotate(-14deg); opacity:0; }
      15%{ opacity:1; }
      80%{ transform: translateY(14px) rotate(7deg); }
      100%{ transform: translateY(0) rotate(0deg); }
    }
    .ring{
      width:340px;height:86px;
      border-radius:999px;
      border:2px solid rgba(248,81,73,.0);
      display:none;
      transform: translateY(86px) scale(.5);
      opacity:0;
    }
    .ring.show{ display:block; animation: ring 360ms ease-out 1; }
    @keyframes ring{
      0%{ border-color: rgba(248,81,73,.0); opacity:0; transform: translateY(86px) scale(.5); }
      35%{ border-color: rgba(248,81,73,.38); opacity:1; }
      100%{ border-color: rgba(248,81,73,.0); opacity:0; transform: translateY(86px) scale(1.08); }
    }

    /* Fireworks canvas */
    #fx{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      display:none;
    }
    #fx.show{ display:block; }
  </style>
</head>

<body>
  <!-- SELECT SCREEN -->
  <div class="safe" id="selectScreen">
    <div class="app">
      <div class="topbar">
        <div class="pill" id="pillState">Stan: WYBIERZ POZIOM</div>
        <div class="pill">iPad: Safari ‚Üí Udostƒôpnij ‚Üí <strong>Dodaj do ekranu poczƒÖtkowego</strong></div>
      </div>

      <div class="card">
        <div class="title">
          <h1>Matematyka Piesk√≥w dla Sonii</h1>
          <p>0‚Äì10 ‚Ä¢ 30 pyta≈Ñ ‚Ä¢ 3 ≈ºycia ‚Ä¢ wybierz poziom</p>
        </div>

        <div class="select">
          <div class="row">
            <label class="nick">
              Nick:
              <input id="nick" type="text" maxlength="16" placeholder="Sonia" value="Sonia" autocomplete="off" />
            </label>
            <div class="pill" style="margin:0;">Start: kliknij kafelek poziomu</div>
          </div>

          <div class="tileRow" id="tileRow">
            <div class="tile" data-mode="beginner">
              <div class="left">
                <strong>PoczƒÖtkujƒÖcy</strong>
                <span>15 s ‚Ä¢ trudno≈õƒá ro≈õnie</span>
              </div>
              <div class="chip">15 s</div>
            </div>
            <div class="tile" data-mode="student">
              <div class="left">
                <strong>Ucze≈Ñ</strong>
                <span>12 s ‚Ä¢ pytania wymieszane</span>
              </div>
              <div class="chip">12 s</div>
            </div>
            <div class="tile" data-mode="master">
              <div class="left">
                <strong>Mistrz</strong>
                <span>bez czasu ‚Ä¢ wpisywanie ‚Ä¢ 3 pr√≥by</span>
              </div>
              <div class="chip">‚àû</div>
            </div>
          </div>

          <div class="subCard">
            <div class="subHead">
              <div>
                <div style="font-weight:950;letter-spacing:.2px;">Ranking (TOP 10 czas√≥w uko≈Ñczenia)</div>
                <div class="tiny">Zapamiƒôtywane na tym urzƒÖdzeniu (przeglƒÖdarka). Po wygranej wraca tu automatycznie.</div>
              </div>
              <div class="tabs" id="tabs">
                <div class="tab active" data-mode="beginner">PoczƒÖtkujƒÖcy</div>
                <div class="tab" data-mode="student">Ucze≈Ñ</div>
                <div class="tab" data-mode="master">Mistrz</div>
              </div>
            </div>

            <div class="tableWrap">
              <table aria-label="Ranking">
                <thead>
                  <tr>
                    <th class="rank">#</th>
                    <th>Nick</th>
                    <th class="time">Czas</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody id="rankBody"></tbody>
              </table>
            </div>

            <div class="tiny">Wygrana = fajerwerki + fanfary przez ~10 s, potem ranking.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN PLAY -->
  <div class="fullscreen" id="playScreen" aria-hidden="true">
    <canvas id="fx"></canvas>

    <div class="playSafe">
      <div class="playCard">
        <div class="playPad">
          <div class="playTop">
            <div class="pill" id="playMode">Tryb: ‚Äî</div>
            <button class="miniBtn" id="quitBtn">Zako≈Ñcz</button>
          </div>

          <div class="hud">
            <div class="bars">
              <div>
                <div class="barlabel"><span>Postƒôp</span><span id="progressText">0%</span></div>
                <div class="progress"><div id="progressBar"></div></div>
              </div>
              <div>
                <div class="barlabel"><span id="timeLabel">Czas</span><span><strong id="timeLeft">‚Äî</strong></span></div>
                <div class="progress timer"><div id="timerBar"></div></div>
              </div>
            </div>

            <div class="stats">
              <div class="stat">Pytanie: <strong id="qNum">0</strong>/30</div>
              <div class="stat">Punkty: <strong id="score">0</strong></div>
              <div class="stat">≈ªycia: <span class="lives" id="lives"></span></div>
              <div class="stat" id="hintStat"><span class="kbd">Tap</span> wybierz odpowied≈∫</div>
            </div>
          </div>

          <div class="questionWrap" id="qWrap">
            <div class="questionLine">
              <div class="big" id="questionText">‚Äî</div>
              <div class="badge" id="modeBadge">1 z 3</div>
            </div>

            <div class="answers" id="answers"></div>
          </div>

          <!-- Typing mode area (only Master) -->
          <div class="typeWrap" id="typeWrap" aria-hidden="true">
            <div class="typeTop">
              <div class="typeDisplay" id="typeDisplay">0</div>
              <div class="tries" id="triesPill">Pr√≥by: 3/3</div>
            </div>
            <div class="keypad" id="keypad">
              <!-- keys injected by JS -->
            </div>
          </div>
        </div>

        <!-- Overlay animations -->
        <div class="stage">
          <div class="stageInner">
            <div class="toast" id="toast">‚Äî</div>

            <div class="winMsg" id="winMsg" aria-hidden="true">
              <p class="h" id="winMsgTitle">Brawo!</p>
              <div class="s">Fajerwerki i fanfary przez chwilƒô, a potem wracamy do rankingu ‚ú®</div>
            </div>

            <div class="sadDog" id="sadDog" aria-hidden="true">
              <div class="ear e1"></div>
              <div class="ear e2"></div>
              <div class="head"></div>
              <div class="brow b1"></div>
              <div class="brow b2"></div>
              <div class="eye e1"></div>
              <div class="eye e2"></div>
              <div class="tear t1"></div>
              <div class="tear t2"></div>
              <div class="snout"></div>
              <div class="nose"></div>
              <div class="mouth"></div>
            </div>

            <div class="dog" id="dog" aria-hidden="true">
              <div class="ear"></div><div class="ear e2"></div>
              <div class="head"></div>
              <div class="eye"></div><div class="eye e2"></div>
              <div class="snout"></div><div class="nose"></div>
              <div class="body"></div><div class="tail"></div>
              <div class="leg l1"></div><div class="leg l2"></div><div class="leg l3"></div>
              <div class="spark"></div>
            </div>

            <div class="bone" id="bone" aria-hidden="true">
              <div class="cap c1"></div><div class="mid"></div><div class="cap c2"></div>
            </div>

            <div class="ring" id="ring" aria-hidden="true"></div>
          </div>
        </div>
      </div><!-- playCard -->
    </div><!-- playSafe -->
  </div><!-- playScreen -->

<script>
(() => {
  "use strict";

  // ===== Config =====
  const TOTAL_QUESTIONS = 30;
  const MAX_LIVES = 3;
  const WIN_CELEBRATION_MS = 10_000; // fanfary 10s
  const LOSE_SHOW_MS = 5_000;        // p≈ÇaczƒÖcy pies 5s

  const MODES = {
    beginner: { label: "PoczƒÖtkujƒÖcy", seconds: 15, hasTimer: true, input: "choice" },
    student:  { label: "Ucze≈Ñ",        seconds: 12, hasTimer: true, input: "choice" },
    master:   { label: "Mistrz",       seconds: 0,  hasTimer: false, input: "type"   },
  };

  // Beginner difficulty ramp (every 5 questions)
  const RAMP_MAX_FACTORS = [4, 5, 6, 7, 8, 10];

  // ===== DOM =====
  const pillState = document.getElementById("pillState");
  const nickEl = document.getElementById("nick");
  const tileRow = document.getElementById("tileRow");
  const tabs = document.getElementById("tabs");
  const rankBody = document.getElementById("rankBody");

  const selectScreen = document.getElementById("selectScreen");
  const playScreen = document.getElementById("playScreen");

  const playMode = document.getElementById("playMode");
  const quitBtn = document.getElementById("quitBtn");

  const qNum = document.getElementById("qNum");
  const scoreEl = document.getElementById("score");
  const livesEl = document.getElementById("lives");
  const questionText = document.getElementById("questionText");
  const answersWrap = document.getElementById("answers");
  const qWrap = document.getElementById("qWrap");

  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const timerBar = document.getElementById("timerBar");
  const timeLeftEl = document.getElementById("timeLeft");
  const timeLabel = document.getElementById("timeLabel");
  const hintStat = document.getElementById("hintStat");
  const modeBadge = document.getElementById("modeBadge");

  const toast = document.getElementById("toast");
  const dog = document.getElementById("dog");
  const bone = document.getElementById("bone");
  const ring = document.getElementById("ring");

  const winMsg = document.getElementById("winMsg");
  const winMsgTitle = document.getElementById("winMsgTitle");
  const sadDog = document.getElementById("sadDog");

  const typeWrap = document.getElementById("typeWrap");
  const typeDisplay = document.getElementById("typeDisplay");
  const triesPill = document.getElementById("triesPill");
  const keypad = document.getElementById("keypad");

  const fx = document.getElementById("fx");
  const fxCtx = fx.getContext("2d");

  // ===== iPad fullscreen polish =====
  function setVhVar(){
    document.documentElement.style.setProperty("--vh", `${window.innerHeight * 0.01}px`);
  }
  setVhVar();
  window.addEventListener("resize", setVhVar);
  window.addEventListener("orientationchange", () => setTimeout(setVhVar, 200));

  // iOS scroll lock
  let scrollY = 0;
  function freezeScroll(){
    scrollY = window.scrollY || 0;
    document.body.style.position = "fixed";
    document.body.style.top = `-${scrollY}px`;
    document.body.style.left = "0";
    document.body.style.right = "0";
    document.body.style.width = "100%";
  }
  function unfreezeScroll(){
    const top = document.body.style.top;
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.left = "";
    document.body.style.right = "";
    document.body.style.width = "";
    const y = top ? -parseInt(top, 10) : 0;
    window.scrollTo(0, y);
  }

  // ===== Utilities =====
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const randInt = (a,b)=> (Math.random()*(b-a+1)|0)+a;

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = (Math.random()*(i+1))|0;
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function sanitizeNick(s){
    s = (s || "").trim();
    if (!s) return "Sonia";
    return s.replace(/\s+/g, " ").slice(0, 16);
  }

  function fmtTime(ms){
    const s = ms/1000;
    const m = Math.floor(s/60);
    const r = s - m*60;
    return m>0 ? `${m}:${r.toFixed(2).padStart(5,"0")}` : `${r.toFixed(2)}s`;
  }

  function fmtDate(ts){
    const d = new Date(ts);
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // ===== Questions per mode =====
  function makeOptions(correct){
    const opts = new Set([correct]);
    const near = clamp(correct + randInt(-10,10), 0, 100);
    if (near !== correct) opts.add(near);
    while(opts.size < 3){
      const r = Math.random()<0.65 ? clamp(correct + randInt(-20,20), 0, 100) : randInt(0,100);
      opts.add(r);
    }
    return shuffle([...opts]);
  }

  function pickFactor(max, allowZero=true){
    if (allowZero && Math.random() < 0.10) return 0;
    return randInt(1, max);
  }

  // Beginner: progressive
  function generateBeginnerQuestions(total){
    const qs = [];
    for (let i=0; i<total; i++){
      const block = Math.min(RAMP_MAX_FACTORS.length-1, Math.floor(i/5));
      const max = RAMP_MAX_FACTORS[block];

      let a = pickFactor(max, true);
      let b = pickFactor(max, true);

      if (block <= 1 && Math.random() < 0.55){
        if (a === 0) a = randInt(1, max);
        if (b === 0) b = randInt(1, max);
      }

      a = clamp(a, 0, 10);
      b = clamp(b, 0, 10);
      qs.push({ a, b, correct: a*b, meta: `√ó0‚Äì${max}` });
    }
    return qs;
  }

  // Student: mixed from 0..10
  function generateStudentQuestions(total){
    const all = [];
    for(let a=0;a<=10;a++){
      for(let b=a;b<=10;b++){
        all.push({a,b,correct:a*b});
      }
    }
    shuffle(all);
    return all.slice(0,total)
      .map(q => (Math.random()<0.5 ? q : {a:q.b,b:q.a,correct:q.correct}))
      .map(q => ({...q, meta:"mieszane"}));
  }

  // Master: typing ‚Äî to make it ‚Äúmaster‚Äù, use 2..10 only
  function generateMasterQuestions(total){
    const all = [];
    for(let a=2;a<=10;a++){
      for(let b=a;b<=10;b++){
        all.push({a,b,correct:a*b});
      }
    }
    shuffle(all);
    return all.slice(0,total)
      .map(q => (Math.random()<0.5 ? q : {a:q.b,b:q.a,correct:q.correct}))
      .map(q => ({...q, meta:"wpisywanie"}));
  }

  function questionsForMode(mode){
    if (mode === "beginner") return generateBeginnerQuestions(TOTAL_QUESTIONS);
    if (mode === "student") return generateStudentQuestions(TOTAL_QUESTIONS);
    return generateMasterQuestions(TOTAL_QUESTIONS);
  }

  // ===== Leaderboard =====
  const LEADER_KEY = "pieski_math_rank_fullscreen_v4";
  function loadBoard(){
    try{
      const raw = localStorage.getItem(LEADER_KEY);
      if (!raw) return { beginner:[], student:[], master:[] };
      const obj = JSON.parse(raw);
      return {
        beginner: Array.isArray(obj.beginner) ? obj.beginner : [],
        student:  Array.isArray(obj.student)  ? obj.student  : [],
        master:   Array.isArray(obj.master)   ? obj.master   : [],
      };
    } catch {
      return { beginner:[], student:[], master:[] };
    }
  }
  function saveBoard(obj){
    try{ localStorage.setItem(LEADER_KEY, JSON.stringify(obj)); } catch {}
  }
  function addScore(mode, nick, timeMs){
    const board = loadBoard();
    board[mode].push({ nick, timeMs, ts: Date.now() });
    board[mode].sort((a,b)=>a.timeMs - b.timeMs);
    board[mode] = board[mode].slice(0, 50);
    saveBoard(board);
  }

  let rankTab = "beginner";
  function setActiveTab(mode){
    [...tabs.querySelectorAll(".tab")].forEach(t => t.classList.toggle("active", t.dataset.mode === mode));
  }
  function renderRanking(mode){
    const board = loadBoard();
    const list = (board[mode] || []).slice().sort((a,b)=>a.timeMs - b.timeMs).slice(0, 10);
    rankBody.innerHTML = "";

    if (!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="rank">‚Äî</td><td style="color:var(--muted)">‚Äî</td><td class="time" style="color:var(--muted)">‚Äî</td><td style="color:var(--muted)">Zagraj i wygraj üôÇ</td>`;
      rankBody.appendChild(tr);
      return;
    }

    list.forEach((e,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${i+1}</td>
        <td>${escapeHtml(e.nick)}</td>
        <td class="time">${fmtTime(e.timeMs)}</td>
        <td>${fmtDate(e.ts)}</td>
      `;
      rankBody.appendChild(tr);
    });
  }

  // ===== Audio =====
  let audioCtx = null;
  let audioReady = false;

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    audioReady = true;
  }

  function beep({freq=880, dur=0.09, type="square", gain=0.06} = {}){
    if (!audioReady) return;
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur + 0.03);
  }

  function thud(){
    if (!audioReady) return;
    const t0 = audioCtx.currentTime;

    const o1 = audioCtx.createOscillator();
    const g1 = audioCtx.createGain();
    o1.type = "sine";
    o1.frequency.setValueAtTime(90, t0);
    o1.frequency.exponentialRampToValueAtTime(42, t0 + 0.18);
    g1.gain.setValueAtTime(0.0001, t0);
    g1.gain.exponentialRampToValueAtTime(0.14, t0 + 0.01);
    g1.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.22);
    o1.connect(g1).connect(audioCtx.destination);
    o1.start(t0);
    o1.stop(t0 + 0.26);
  }

  // Fanfare loop (10s)
  let fanfareTimer = null;
  let fanfareStopTimer = null;

  function stopFanfare(){
    if (fanfareTimer){ clearInterval(fanfareTimer); fanfareTimer = null; }
    if (fanfareStopTimer){ clearTimeout(fanfareStopTimer); fanfareStopTimer = null; }
  }

  function startFanfare10s(){
    stopFanfare();
    if (!audioReady) return;

    const motif = () => {
      const seq = [
        {f:523.25, t:0},
        {f:659.25, t:0.16},
        {f:783.99, t:0.32},
        {f:1046.5, t:0.48},
        {f:783.99, t:0.72},
        {f:1046.5, t:0.88},
        {f:1318.5, t:1.04},
        {f:1567.98,t:1.28},
      ];
      seq.forEach(n => setTimeout(()=>beep({freq:n.f, dur:0.10, type:"square", gain:0.06}), n.t*1000));
      setTimeout(()=>beep({freq:2093.0, dur:0.18, type:"triangle", gain:0.05}), 1550);
    };

    motif();
    fanfareTimer = setInterval(motif, 2000);
    fanfareStopTimer = setTimeout(stopFanfare, WIN_CELEBRATION_MS);
  }

  // ===== Fireworks =====
  let fxRunning = false;
  let particles = [];
  let lastT = 0;
  let burstInterval = null;

  function resizeFx(){
    const rect = fx.getBoundingClientRect();
    fx.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
    fx.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
  }

  function spawnBurst(){
    const w = fx.width, h = fx.height;
    const cx = randInt(Math.floor(w*0.2), Math.floor(w*0.8));
    const cy = randInt(Math.floor(h*0.10), Math.floor(h*0.45));
    const colors = ["#58a6ff","#2ea043","#f85149","#a371f7","#d29922","#c9d1d9"];
    const col = colors[randInt(0, colors.length-1)];
    const count = randInt(34, 56);
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = randInt(190, 460);
      particles.push({ x:cx, y:cy, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, life:randInt(700,1200), age:0, col });
    }
  }

  function startFireworks(){
    resizeFx();
    fx.classList.add("show");
    fxRunning = true;
    particles = [];
    lastT = performance.now();
    for(let i=0;i<3;i++) spawnBurst();
    if (burstInterval) clearInterval(burstInterval);
    burstInterval = setInterval(()=>{ if(fxRunning) spawnBurst(); }, 620);
    requestAnimationFrame(fxLoop);
  }

  function stopFireworks(){
    fxRunning = false;
    fx.classList.remove("show");
    particles = [];
    if (burstInterval){ clearInterval(burstInterval); burstInterval = null; }
  }

  function fxLoop(now){
    if (!fxRunning) return;
    const dt = clamp(now - lastT, 0, 40);
    lastT = now;

    const w = fx.width, h = fx.height;

    fxCtx.save();
    fxCtx.globalAlpha = 0.18;
    fxCtx.fillStyle = "#0d1117";
    fxCtx.fillRect(0,0,w,h);
    fxCtx.restore();

    const g = 860;
    const next = [];
    for(const p of particles){
      p.age += dt;
      if (p.age >= p.life) continue;

      const t = dt/1000;
      p.vx *= 0.98;
      p.vy = p.vy*0.98 + g*t;
      p.x += p.vx*t;
      p.y += p.vy*t;

      const alpha = 1 - (p.age / p.life);
      fxCtx.save();
      fxCtx.globalAlpha = alpha;
      fxCtx.fillStyle = p.col;
      const r = 3 * devicePixelRatio;
      fxCtx.beginPath();
      fxCtx.arc(p.x, p.y, r, 0, Math.PI*2);
      fxCtx.fill();
      fxCtx.restore();

      next.push(p);
    }
    particles = next;
    requestAnimationFrame(fxLoop);
  }
  window.addEventListener("resize", ()=>{ if(fxRunning) resizeFx(); });

  // ===== Game state =====
  const game = {
    mode: "beginner",
    limitMs: MODES.beginner.seconds * 1000,
    nick: "Sonia",
    questions: [],
    index: 0,
    score: 0,
    lives: MAX_LIVES,
    locked: false,
    deadline: 0,
    timerId: null,
    runStart: 0,
    runEnd: 0,
    celebrateTimer: null,

    // typing mode
    typed: "",
    triesLeft: 3,
  };

  // ===== UI helpers =====
  function setStateLabel(s){ pillState.textContent = s; }

  function showSelect(){
    selectScreen.style.display = "";
    playScreen.classList.remove("show");
    playScreen.setAttribute("aria-hidden","true");
    unfreezeScroll();
    document.body.style.overflow = "";

    stopTimer();
    stopFireworks();
    stopFanfare();
    clearOverlay();
    hideWinMsg();
    hideSadDog();
    hideTypingUI();

    setStateLabel("Stan: WYBIERZ POZIOM");
    setActiveTab(rankTab);
    renderRanking(rankTab);
  }

  function showPlay(){
    selectScreen.style.display = "none";
    playScreen.classList.add("show");
    playScreen.setAttribute("aria-hidden","false");
    freezeScroll();
    document.body.style.overflow = "hidden";
    setStateLabel("Stan: GRA");
  }

  function renderLives(){
    livesEl.innerHTML = "";
    for(let i=0;i<MAX_LIVES;i++){
      const d = document.createElement("span");
      d.className = "heart" + (i < game.lives ? " on" : "");
      livesEl.appendChild(d);
    }
  }

  function setProgress(){
    const pct = (game.index / TOTAL_QUESTIONS) * 100;
    progressBar.style.width = `${pct}%`;
    progressText.textContent = `${Math.round(pct)}%`;
  }

  function clearOverlay(){
    toast.classList.remove("show");
    dog.classList.remove("show","wag");
    bone.classList.remove("show","drop");
    ring.classList.remove("show");
    qWrap.classList.remove("danger","shake");
  }

  function showToast(msg, kind="info"){
    toast.textContent = msg;
    toast.classList.add("show");
    toast.style.borderColor =
      kind==="good" ? "rgba(46,160,67,.65)" :
      kind==="bad"  ? "rgba(248,81,73,.65)" :
                      "rgba(88,166,255,.45)";
    toast.style.boxShadow =
      kind==="good" ? "0 0 0 2px rgba(46,160,67,.14)" :
      kind==="bad"  ? "0 0 0 2px rgba(248,81,73,.12)" :
                      "0 0 0 2px rgba(88,166,255,.10)";
    setTimeout(()=>toast.classList.remove("show"), 950);
  }

  function lockAnswers(v){
    game.locked = v;
    [...answersWrap.querySelectorAll("button")].forEach(b => b.disabled = v);
    [...keypad.querySelectorAll("button")].forEach(b => b.disabled = v);
  }

  function showWinMsg(nick){
    const lower = (nick || "").trim().toLowerCase();
    const msg = (lower === "sonia" || lower === "soniu")
      ? "Brawo Soniu, idzie Ci coraz lepiej!"
      : `Brawo ${nick}, idzie Ci coraz lepiej!`;
    winMsgTitle.textContent = msg;
    winMsg.classList.add("show");
    winMsg.setAttribute("aria-hidden","false");
  }
  function hideWinMsg(){
    winMsg.classList.remove("show");
    winMsg.setAttribute("aria-hidden","true");
  }

  function showSadDog(){
    sadDog.classList.add("show");
    sadDog.setAttribute("aria-hidden","false");
  }
  function hideSadDog(){
    sadDog.classList.remove("show");
    sadDog.setAttribute("aria-hidden","true");
  }

  function showTypingUI(){
    typeWrap.classList.add("show");
    typeWrap.setAttribute("aria-hidden","false");
    hintStat.innerHTML = `<span class="kbd">Tap</span> wpisuj wynik`;
    modeBadge.textContent = "Wpisz wynik";
  }
  function hideTypingUI(){
    typeWrap.classList.remove("show");
    typeWrap.setAttribute("aria-hidden","true");
    hintStat.innerHTML = `<span class="kbd">Tap</span> wybierz odpowied≈∫`;
    modeBadge.textContent = "1 z 3";
    typeDisplay.textContent = "0";
    triesPill.textContent = "Pr√≥by: 3/3";
  }

  // ===== Timer =====
  function stopTimer(){
    if (game.timerId){
      clearInterval(game.timerId);
      game.timerId = null;
    }
  }

  function startTimer(){
    stopTimer();
    game.deadline = performance.now() + game.limitMs;
    updateTimerUI();
    game.timerId = setInterval(() => {
      if (game.locked) return;
      updateTimerUI();
      if (game.deadline - performance.now() <= 0){
        onTimeout();
      }
    }, 80);
  }

  function updateTimerUI(){
    const leftMs = clamp(game.deadline - performance.now(), 0, game.limitMs);
    const leftS = Math.ceil(leftMs / 1000);
    timeLeftEl.textContent = `${leftS}s`;
    timerBar.style.width = `${(leftMs / game.limitMs) * 100}%`;
  }

  function setTimerDisabledUI(){
    timeLabel.textContent = "Czas";
    timeLeftEl.textContent = "bez limitu";
    timerBar.style.width = "100%";
  }

  function onTimeout(){
    if (game.locked) return;
    lockAnswers(true);
    stopTimer();
    wrongSequence(true);
  }

  // ===== Keypad (Master typing) =====
  function buildKeypad(){
    keypad.innerHTML = "";
    const keys = [
      "1","2","3",
      "4","5","6",
      "7","8","9",
      "C","0","OK"
    ];

    keys.forEach(k => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "key";
      b.textContent = k;

      if (k === "OK") b.classList.add("ok");
      if (k === "C") b.classList.add("del");

      b.addEventListener("click", () => onKey(k));
      keypad.appendChild(b);
    });
  }

  function setTyped(str){
    game.typed = str;
    typeDisplay.textContent = str.length ? str : "0";
  }

  function updateTries(){
    triesPill.textContent = `Pr√≥by: ${game.triesLeft}/3`;
  }

  function onKey(k){
    if (game.locked || game.mode !== "master") return;

    ensureAudio();

    if (k === "C"){
      setTyped("");
      beep({freq: 300, dur:0.05, type:"square", gain:0.03});
      return;
    }
    if (k === "OK"){
      submitTyped();
      return;
    }

    // digit
    if (game.typed.length >= 3) return; // max 3 digits (<=100)
    setTyped(game.typed + k);
    beep({freq: 520, dur:0.03, type:"square", gain:0.03});
  }

  function submitTyped(){
    const q = game.questions[game.index];
    const val = Number(game.typed);
    if (!Number.isFinite(val)) return;

    if (val === q.correct){
      // correct
      lockAnswers(true);
      correctSequence();
      return;
    }

    // wrong attempt (does not cost life until 3 tries used)
    game.triesLeft -= 1;
    updateTries();

    // feedback
    thud();
    qWrap.classList.add("shake","danger");
    setTimeout(()=>qWrap.classList.remove("shake"), 260);

    if (game.triesLeft > 0){
      showToast(`Nie‚Ä¶ spr√≥buj jeszcze raz (${game.triesLeft} pr√≥by)`, "bad");
      setTyped("");
      return;
    }

    // 0 tries left => lose one life and go next question
    lockAnswers(true);
    showToast(`Zabrak≈Ço pr√≥b‚Ä¶ poprawnie: ${q.correct}`, "bad");
    setTimeout(() => {
      wrongSequence(false, true); // typedFail=true (loses a life)
    }, 450);
  }

  // ===== Rendering question =====
  function renderQuestion(){
    const q = game.questions[game.index];
    qNum.textContent = String(game.index + 1);
    scoreEl.textContent = String(game.score);
    renderLives();
    setProgress();
    questionText.textContent = `${q.a} √ó ${q.b} = ?`;
    qWrap.classList.remove("danger","shake");
    hideSadDog();
    hideWinMsg();

    const meta =
      game.mode === "beginner" ? ` ‚Ä¢ ${q.meta}` :
      game.mode === "student"  ? " ‚Ä¢ mieszane" :
                                " ‚Ä¢ wpisywanie";

    if (MODES[game.mode].hasTimer){
      timeLabel.textContent = "Czas";
      timeLeftEl.textContent = `${MODES[game.mode].seconds}s`;
      timerBar.style.width = "100%";
    } else {
      setTimerDisabledUI();
    }

    playMode.textContent =
      game.mode === "master"
        ? `Tryb: Mistrz ‚Ä¢ bez czasu ‚Ä¢ wpisywanie ‚Ä¢ 3 pr√≥by${meta ? "" : ""}`
        : `Tryb: ${MODES[game.mode].label} ‚Ä¢ ${MODES[game.mode].seconds}s${meta}`;

    if (game.mode === "master"){
      // typing mode
      answersWrap.innerHTML = "";
      answersWrap.style.display = "none";
      showTypingUI();

      game.triesLeft = 3;
      updateTries();
      setTyped("");

      lockAnswers(false);
      stopTimer();
      setTimerDisabledUI();
      return;
    }

    // choice mode
    answersWrap.style.display = "grid";
    hideTypingUI();

    const options = makeOptions(q.correct);
    answersWrap.innerHTML = "";
    options.forEach(val => {
      const b = document.createElement("button");
      b.className = "ansBtn";
      b.textContent = String(val);
      b.addEventListener("click", () => onAnswer(val));
      answersWrap.appendChild(b);
    });

    lockAnswers(false);
    game.limitMs = MODES[game.mode].seconds * 1000;
    startTimer();
  }

  // ===== Gameplay =====
  function startGame(mode){
    ensureAudio();

    game.nick = sanitizeNick(nickEl.value);
    nickEl.value = game.nick;

    game.mode = mode;
    game.questions = questionsForMode(mode);
    game.index = 0;
    game.score = 0;
    game.lives = MAX_LIVES;
    game.locked = false;
    game.runStart = performance.now();
    game.runEnd = 0;

    clearOverlay();
    hideWinMsg();
    hideSadDog();

    // show play fullscreen
    selectScreen.style.display = "none";
    playScreen.classList.add("show");
    playScreen.setAttribute("aria-hidden","false");
    freezeScroll();
    document.body.style.overflow = "hidden";
    setStateLabel("Stan: GRA");

    renderQuestion();
  }

  function nextStep(){
    game.index += 1;
    if (game.index >= TOTAL_QUESTIONS){
      endWin();
      return;
    }
    renderQuestion();
  }

  function correctSequence(){
    // in typing mode we already locked answers before calling
    game.score += 1;
    scoreEl.textContent = String(game.score);

    dog.classList.add("show","wag");
    bone.classList.remove("show","drop");
    ring.classList.remove("show");

    showToast("Dobrze! üê∂", "good");
    beep({freq: 880, dur: 0.08, type:"square", gain:0.06});
    setTimeout(()=>beep({freq: 1174.66, dur: 0.09, type:"triangle", gain:0.05}), 90);

    setTimeout(() => {
      dog.classList.remove("show","wag");
      nextStep();
    }, 620);
  }

  // wrongSequence(timedOut, typedFail=false)
  // typedFail=true means: master typing used all tries -> lose one life (but no bone drop animation again)
  function wrongSequence(timedOut, typedFail=false){
    // if typedFail, we already displayed info toast and maybe shake
    if (!typedFail){
      bone.classList.add("show","drop");
      ring.classList.add("show");
      thud();
      qWrap.classList.add("shake","danger");
      setTimeout(()=>qWrap.classList.remove("shake"), 260);
      showToast(timedOut ? "Czas minƒÖ≈Ç! ü¶¥" : "Ups‚Ä¶ ü¶¥", "bad");
    }

    game.lives -= 1;
    renderLives();

    setTimeout(() => {
      bone.classList.remove("show","drop");
      ring.classList.remove("show");
      if (game.lives <= 0){
        endLose();
      } else {
        nextStep();
      }
    }, typedFail ? 350 : 900);
  }

  function onAnswer(choice){
    if (game.locked || game.mode === "master") return;

    ensureAudio();
    lockAnswers(true);
    stopTimer();

    const q = game.questions[game.index];
    const ok = (choice === q.correct);

    if (ok) correctSequence();
    else wrongSequence(false);
  }

  function endLose(){
    stopTimer();
    lockAnswers(true);
    game.runEnd = performance.now();

    clearOverlay();
    hideWinMsg();
    dog.classList.remove("show","wag");
    bone.classList.remove("show","drop");
    ring.classList.remove("show");

    showSadDog();
    showToast(`O nie‚Ä¶ üò¢ Wynik: ${game.score}/${TOTAL_QUESTIONS}`, "bad");
    beep({freq: 220, dur: 0.14, type:"sine", gain:0.06});
    setTimeout(()=>beep({freq: 196, dur: 0.18, type:"sine", gain:0.06}), 160);

    // show sad dog 5s
    setTimeout(() => {
      hideSadDog();
      rankTab = game.mode;
      setActiveTab(rankTab);
      showSelect();
    }, LOSE_SHOW_MS);
  }

  function endWin(){
    stopTimer();
    lockAnswers(true);
    game.runEnd = performance.now();

    const totalMs = Math.max(0, game.runEnd - game.runStart);
    addScore(game.mode, game.nick, Math.round(totalMs));
    rankTab = game.mode;

    clearOverlay();
    hideSadDog();
    showWinMsg(game.nick);
    showToast(`Wygrana! üéâ ${game.nick} ‚Ä¢ Czas: ${fmtTime(totalMs)}`, "good");

    startFireworks();
    startFanfare10s();

    if (game.celebrateTimer) clearTimeout(game.celebrateTimer);
    game.celebrateTimer = setTimeout(() => {
      stopFireworks();
      stopFanfare();
      hideWinMsg();
      setActiveTab(rankTab);
      showSelect();
    }, WIN_CELEBRATION_MS);
  }

  function showSelect(){
    // back to select view
    selectScreen.style.display = "";
    playScreen.classList.remove("show");
    playScreen.setAttribute("aria-hidden","true");
    unfreezeScroll();
    document.body.style.overflow = "";

    stopTimer();
    stopFireworks();
    stopFanfare();
    clearOverlay();
    hideWinMsg();
    hideSadDog();
    hideTypingUI();
    answersWrap.style.display = "grid";

    setStateLabel("Stan: WYBIERZ POZIOM");
    renderRanking(rankTab);
  }

  // ===== Fireworks =====
  function startFireworks(){
    resizeFx();
    fx.classList.add("show");
    fxRunning = true;
    particles = [];
    lastT = performance.now();
    for(let i=0;i<3;i++) spawnBurst();
    if (burstInterval) clearInterval(burstInterval);
    burstInterval = setInterval(()=>{ if(fxRunning) spawnBurst(); }, 620);
    requestAnimationFrame(fxLoop);
  }

  // ===== Key events (optional) =====
  window.addEventListener("keydown", (e) => {
    if (game.mode !== "master" || !playScreen.classList.contains("show")) return;
    if (e.key >= "0" && e.key <= "9"){ onKey(e.key); }
    if (e.key === "Enter"){ onKey("OK"); }
    if (e.key === "Backspace" || e.key === "Delete"){ onKey("C"); }
  });

  // ===== Events =====
  tileRow.addEventListener("click", (e) => {
    const tile = e.target.closest(".tile");
    if (!tile) return;
    startGame(tile.dataset.mode);
  });

  tabs.addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    rankTab = t.dataset.mode;
    setActiveTab(rankTab);
    renderRanking(rankTab);
    ensureAudio();
  });

  quitBtn.addEventListener("click", () => {
    if (game.celebrateTimer) { clearTimeout(game.celebrateTimer); game.celebrateTimer = null; }
    stopTimer();
    stopFireworks();
    stopFanfare();
    clearOverlay();
    hideWinMsg();
    hideSadDog();
    showSelect();
  });

  // unlock audio on first touch anywhere
  window.addEventListener("pointerdown", () => { ensureAudio(); }, { once:true });

  // ===== Init =====
  function init(){
    buildKeypad();
    setStateLabel("Stan: WYBIERZ POZIOM");
    setActiveTab(rankTab);
    renderRanking(rankTab);
    renderLives();
    hideTypingUI();
  }
  init();
})();
</script>
</body>
</html>
